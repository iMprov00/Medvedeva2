

      

        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–∞—á–∞–º–∏</h1>
            <a href="/admin/specialties" class="btn btn-outline-primary">
                <i class="bi bi-tags me-2"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—è–º–∏
            </a>
        </div>
        
        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Ä–∞—á–∞ -->
        <div class="card mb-5">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-person-plus me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –≤—Ä–∞—á–∞</h5>
                <button type="button" class="btn btn-sm btn-light" onclick="toggleForm()" id="toggleFormBtn">
                    <i class="bi bi-chevron-up"></i> –°–∫—Ä—ã—Ç—å
                </button>
            </div>
            <div class="card-body" id="addDoctorForm">
                <form action="/admin/doctors" method="post" enctype="multipart/form-data" id="doctor-form">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="last_name" class="form-label">–§–∞–º–∏–ª–∏—è *</label>
                            <input type="text" class="form-control" id="last_name" name="doctor[last_name]" required>
                        </div>
                        <div class="col-md-4">
                            <label for="first_name" class="form-label">–ò–º—è *</label>
                            <input type="text" class="form-control" id="first_name" name="doctor[first_name]" required>
                        </div>
                        <div class="col-md-4">
                            <label for="middle_name" class="form-label">–û—Ç—á–µ—Å—Ç–≤–æ</label>
                            <input type="text" class="form-control" id="middle_name" name="doctor[middle_name]">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ *</label>
                            <div class="specialties-container border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                <% if defined?(Specialty) && Specialty.any? %>
                                    <% Specialty.all.each do |specialty| %>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="doctor[specialty_ids][]" 
                                                   value="<%= specialty.id %>" 
                                                   id="specialty_<%= specialty.id %>">
                                            <label class="form-check-label" for="specialty_<%= specialty.id %>">
                                                <%= specialty.name %>
                                            </label>
                                        </div>
                                    <% end %>
                                <% else %>
                                    <div class="alert alert-warning mb-0">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        –ù–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π. –°–Ω–∞—á–∞–ª–∞ 
                                        <a href="/admin/specialties" class="alert-link">–¥–æ–±–∞–≤—å—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>.
                                    </div>
                                <% end %>
                            </div>
                            <small class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π</small>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-12">
                                    <label for="experience_years" class="form-label">–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã (–ª–µ—Ç)</label>
                                    <input type="number" class="form-control" id="experience_years" 
                                           name="doctor[experience_years]" min="0" max="60">
                                </div>
                                
                                <div class="col-12 mt-3">
                                    <label for="booking_link" class="form-label">–°—Å—ã–ª–∫–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –ø—Ä–∏–µ–º</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-link-45deg"></i>
                                        </span>
                                        <input type="url" 
                                               class="form-control" 
                                               id="booking_link" 
                                               name="doctor[booking_link]"
                                               placeholder="https://example.com/booking –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–æ—Ä–∫-–ø–ª–µ–π—Å"
                                               pattern="https?://.+">
                                    </div>
                                </div>

                                <div class="col-12 mt-3">
                                    <label for="photo" class="form-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –≤—Ä–∞—á–∞ (PNG)</label>
                                    <div class="file-upload-container">
                                        <div class="file-upload-preview mb-3 text-center">
                                            <div class="photo-preview-container" onclick="document.getElementById('photo').click()" id="preview-container">
                                                <div class="photo-background" id="preview-bg"></div>
                                                <img id="photo-preview" 
                                                     src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300' viewBox='0 0 300 300'%3E%3Crect width='300' height='300' fill='%23f8f9fa'/%3E%3Ctext x='50%25' y='45%25' text-anchor='middle' font-family='Arial' font-size='14' fill='%236c757d'%3E–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ (PNG)%3C/text%3E%3Ctext x='50%25' y='55%25' text-anchor='middle' font-family='Arial' font-size='12' fill='%23999'%3E–° –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º —Ñ–æ–Ω–æ–º%3C/text%3E%3C/svg%3E" 
                                                     alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ" 
                                                     class="photo-preview">
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è PNG —Å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º —Ñ–æ–Ω–æ–º (300x300 –ø–∏–∫—Å–µ–ª–µ–π)</small>
                                                <br>
                                                <small class="text-muted">–ù–∞ —Å–∞–π—Ç–µ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω —Ü–≤–µ—Ç–Ω–æ–π —Ñ–æ–Ω</small>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="file" 
                                                   class="form-control" 
                                                   id="photo" 
                                                   name="photo" 
                                                   accept="image/png" 
                                                   style="display: none;"
                                                   onchange="previewPhoto(this)">
                                            <button type="button" class="btn btn-outline-secondary w-100" onclick="document.getElementById('photo').click()">
                                                <i class="bi bi-camera me-2"></i>–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é (PNG)
                                            </button>
                                        </div>
                                        <input type="hidden" id="photo_path" name="doctor[photo_path]">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <label for="bio" class="form-label">–ë–∏–æ–≥—Ä–∞—Ñ–∏—è *</label>
                            <textarea class="form-control" id="bio" name="doctor[bio]" rows="6" required></textarea>
                        </div>
                        
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    –ü–æ–ª—è –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ * –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                                    <br>
                                    <i class="bi bi-lightbulb me-1"></i>
                                    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ PNG —Å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º —Ñ–æ–Ω–æ–º –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-plus-circle me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –≤—Ä–∞—á–∞
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π -->
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-people me-2"></i>–°–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π (<span id="doctors-count"><%= @doctors.count %></span>)</h5>
                <div class="d-flex gap-2">
                    <input type="text" class="form-control form-control-sm" style="width: 200px;" 
                           placeholder="–ü–æ–∏—Å–∫ –≤—Ä–∞—á–µ–π..." id="search-doctors">
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshList()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <% if @doctors.empty? %>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        –í—Ä–∞—á–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –≤—Ä–∞—á–∞, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É –≤—ã—à–µ.
                    </div>
                <% else %>
                    <div class="row" id="doctors-list">
                        <% @doctors.each_with_index do |doctor, index| %>
                            <div class="col-md-6 col-lg-4 mb-4 doctor-item" data-id="<%= doctor.id %>" 
                                 data-name="<%= doctor.full_name.downcase %>"
                                 data-specialties="<%= doctor.specialties.map(&:name).join(' ').downcase %>">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <!-- –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ —Å —á–µ—Ä–µ–¥—É—é—â–∏–º—Å—è —Ñ–æ–Ω–æ–º -->
                                        <div class="text-center mb-3">
                                            <div class="photo-preview-container mx-auto" style="width: 200px; height: 200px;">
                                                <div class="photo-background <%= "bg-preview-#{index % 2}" %>"></div>
                                                <% if doctor.photo_path %>
                                                    <img src="<%= doctor.photo_path %>" 
                                                         alt="<%= doctor.full_name %>" 
                                                         class="photo-preview">
                                                <% else %>
                                                    <i class="bi bi-person display-4 text-muted"></i>
                                                <% end %>
                                            </div>
                                        </div>
                                        <h5 class="card-title text-center"><%= doctor.full_name %></h5>
                                        <h6 class="card-subtitle mb-3 text-center text-muted">
                                            <%= doctor.specialties_text %>
                                        </h6>
                                        <p class="card-text">
                                            <small class="text-muted">
                                                <i class="bi bi-clock-history me-1"></i>
                                                <%= doctor.experience_text %>
                                            </small>
                                        </p>
                                        <p class="card-text" style="height: 60px; overflow: hidden;">
                                            <%= doctor.bio.truncate(100) %>
                                        </p>
                                        <% if doctor.photo_path %>
                                            <p class="card-text">
                                                <small class="text-muted">
                                                    <i class="bi bi-image me-1"></i>
                                                    <%= File.extname(doctor.photo_path).upcase %>
                                                </small>
                                            </p>
                                        <% end %>
                                    </div>
                                    <div class="card-footer bg-transparent">
                                        <div class="doctor-actions">
                                            <button type="button" class="btn btn-warning btn-sm" 
                                                    onclick="editDoctor(<%= doctor.id %>)">
                                                <i class="bi bi-pencil me-1"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                            </button>
                                            <form action="/admin/doctors/<%= doctor.id %>/delete" method="post" class="d-inline ms-auto">
                                                <button type="submit" class="btn btn-danger btn-sm">
                                                    <i class="bi bi-trash me-1"></i>–£–¥–∞–ª–∏—Ç—å
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% end %>
                    </div>
                <% end %>
            </div>
        </div>
    </div>


<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–∞—á–∞ -->
<div class="modal fade" id="editDoctorModal" tabindex="-1" aria-labelledby="editDoctorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-lg-custom">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editDoctorModalLabel">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–∞—á–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-doctor-form" method="post" enctype="multipart/form-data">
          <input type="hidden" id="edit_doctor_id" name="doctor[id]">
          
          <div class="row g-3">
            <div class="col-md-4">
              <label for="edit_last_name" class="form-label">–§–∞–º–∏–ª–∏—è *</label>
              <input type="text" class="form-control" id="edit_last_name" name="doctor[last_name]" required>
            </div>
            <div class="col-md-4">
              <label for="edit_first_name" class="form-label">–ò–º—è *</label>
              <input type="text" class="form-control" id="edit_first_name" name="doctor[first_name]" required>
            </div>
            <div class="col-md-4">
              <label for="edit_middle_name" class="form-label">–û—Ç—á–µ—Å—Ç–≤–æ</label>
              <input type="text" class="form-control" id="edit_middle_name" name="doctor[middle_name]">
            </div>
            
            <div class="col-md-6">
              <label class="form-label">–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ *</label>
              <div class="specialties-container border rounded p-3" style="max-height: 200px; overflow-y: auto;" id="edit-specialties-container">
                <!-- –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
              </div>
              <small class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π</small>
            </div>
            
            <div class="col-md-6">
              <div class="row">
                <div class="col-12">
                  <label for="edit_experience_years" class="form-label">–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã (–ª–µ—Ç)</label>
                  <input type="number" class="form-control" id="edit_experience_years" 
                         name="doctor[experience_years]" min="0" max="60">
                </div>

                <div class="col-12">
                        <label for="edit_booking_link" class="form-label">–°—Å—ã–ª–∫–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –ø—Ä–∏–µ–º</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-link-45deg"></i>
                            </span>
                            <input type="url" 
                                   class="form-control" 
                                   id="edit_booking_link" 
                                   name="doctor[booking_link]"
                                   placeholder="https://example.com/booking"
                                   pattern="https?://.+">
                        </div>
                    </div>
                
                <div class="col-12 mt-3">
                  <label for="edit_photo" class="form-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –≤—Ä–∞—á–∞</label>
                  <div class="file-upload-container">
                    <div class="file-upload-preview mb-3 text-center">
                      <div class="photo-preview-container" onclick="document.getElementById('edit_photo').click()" id="edit-preview-container">
                        <div class="photo-background" id="edit-preview-bg"></div>
                        <img id="edit_photo_preview" 
                             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300' viewBox='0 0 300 300'%3E%3Crect width='300' height='300' fill='%23f8f9fa'/%3E%3Ctext x='50%25' y='45%25' text-anchor='middle' font-family='Arial' font-size='14' fill='%236c757d'%3E–ó–∞–≥—Ä—É–∑–∫–∞...%3C/text%3E%3C/svg%3E" 
                             alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ" 
                             class="photo-preview">
                      </div>
                      <div class="mt-2">
                        <small class="text-muted">–¢–µ–∫—É—â–µ–µ —Ñ–æ—Ç–æ</small>
                        <br>
                        <small class="text-muted">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</small>
                      </div>
                    </div>
                    <div class="input-group">
                      <input type="file" 
                             class="form-control" 
                             id="edit_photo" 
                             name="photo" 
                             accept="image/png" 
                             style="display: none;"
                             onchange="previewEditPhoto(this)">
                      <button type="button" class="btn btn-outline-secondary w-100" onclick="document.getElementById('edit_photo').click()">
                        <i class="bi bi-camera me-2"></i>–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é (PNG)
                      </button>
                    </div>
                    <input type="hidden" id="edit_photo_path" name="doctor[photo_path]">
                    <input type="hidden" id="current_photo_path" name="doctor[current_photo_path]">
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-12">
              <label for="edit_bio" class="form-label">–ë–∏–æ–≥—Ä–∞—Ñ–∏—è *</label>
              <textarea class="form-control" id="edit_bio" name="doctor[bio]" rows="6" required></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-success" id="save-changes-btn">
          <i class="bi bi-save me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        </button>
      </div>
    </div>
  </div>
</div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
<script>
    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const editDoctorModal = new bootstrap.Modal(document.getElementById('editDoctorModal'));
    const editDoctorForm = document.getElementById('edit-doctor-form');
    
    // –°–∫—Ä—ã—Ç–∏–µ/–ø–æ–∫–∞–∑–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    function toggleForm() {
        const form = document.getElementById('addDoctorForm');
        const btn = document.getElementById('toggleFormBtn');
        if (form.style.display === 'none') {
            form.style.display = 'block';
            btn.innerHTML = '<i class="bi bi-chevron-up"></i> –°–∫—Ä—ã—Ç—å';
        } else {
            form.style.display = 'none';
            btn.innerHTML = '<i class="bi bi-chevron-down"></i> –ü–æ–∫–∞–∑–∞—Ç—å';
        }
    }
    
    // –ü–æ–∏—Å–∫ –≤—Ä–∞—á–µ–π
    const searchInput = document.getElementById('search-doctors');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const doctorItems = document.querySelectorAll('.doctor-item');
            let visibleCount = 0;
            
            doctorItems.forEach(item => {
                const name = item.getAttribute('data-name');
                const specialties = item.getAttribute('data-specialties');
                
                if (name.includes(searchTerm) || specialties.includes(searchTerm) || searchTerm === '') {
                    item.style.display = 'block';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            document.getElementById('doctors-count').textContent = visibleCount;
        });
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞
    function refreshList() {
        window.location.reload();
    }
    
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–∞—á–∞
async function editDoctor(doctorId) {
    try {
        console.log(`üöÄ –ù–∞—á–∞–ª–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–∞—á–∞ ID: ${doctorId}`);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        document.getElementById('save-changes-btn').disabled = true;
        document.getElementById('save-changes-btn').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> –ó–∞–≥—Ä—É–∑–∫–∞...';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤—Ä–∞—á–∞
        console.log(`üì° –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –≤—Ä–∞—á–∞ ${doctorId}...`);
        const response = await fetch(`/admin/doctors/${doctorId}/edit`);
        
        console.log(`üì• –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${response.status}`);
        }
        
        const doctor = await response.json();
        console.log(`‚úÖ –î–∞–Ω–Ω—ã–µ –≤—Ä–∞—á–∞ –ø–æ–ª—É—á–µ–Ω—ã:`, doctor);
        console.log(`üîó –°—Å—ã–ª–∫–∞ –∏–∑ JSON: '${doctor.booking_link}'`);
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('edit_doctor_id').value = doctor.id;
        document.getElementById('edit_last_name').value = doctor.last_name;
        document.getElementById('edit_first_name').value = doctor.first_name;
        document.getElementById('edit_middle_name').value = doctor.middle_name || '';
        document.getElementById('edit_experience_years').value = doctor.experience_years || '';
        document.getElementById('edit_bio').value = doctor.bio;
        document.getElementById('edit_photo_path').value = doctor.photo_path || '';
        document.getElementById('edit_booking_link').value = doctor.booking_link || ''; // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ç—É —Å—Ç—Ä–æ–∫—É!
        document.getElementById('current_photo_path').value = doctor.photo_path || '';
        
        console.log(`üìù –§–æ—Ä–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞. –°—Å—ã–ª–∫–∞ –≤ –ø–æ–ª–µ: '${document.getElementById('edit_booking_link').value}'`);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
        await loadSpecialtiesForEdit(doctor.specialties || []);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Ñ–æ—Ç–æ
        if (doctor.photo_path) {
            document.getElementById('edit_photo_preview').src = doctor.photo_path;
        }
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        editDoctorForm.action = `/admin/doctors/${doctorId}/update`;
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
        document.getElementById('save-changes-btn').disabled = false;
        document.getElementById('save-changes-btn').innerHTML = '<i class="bi bi-save me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
        
        console.log(`‚úÖ –§–æ—Ä–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é`);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        editDoctorModal.show();
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤—Ä–∞—á–∞:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤—Ä–∞—á–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        document.getElementById('save-changes-btn').disabled = false;
        document.getElementById('save-changes-btn').innerHTML = '<i class="bi bi-save me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
    }
}
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    async function loadSpecialtiesForEdit(doctorSpecialties) {
        try {
            const response = await fetch('/admin/specialties/list');
            const specialties = await response.json();
            
            const container = document.getElementById('edit-specialties-container');
            container.innerHTML = '';
            
            const doctorSpecialtyIds = doctorSpecialties.map(s => s.id);
            
            specialties.forEach(specialty => {
                const div = document.createElement('div');
                div.className = 'form-check mb-2';
                
                const isChecked = doctorSpecialtyIds.includes(specialty.id);
                
                div.innerHTML = `
                    <input class="form-check-input" type="checkbox" 
                           name="doctor[specialty_ids][]" 
                           value="${specialty.id}" 
                           id="edit_specialty_${specialty.id}"
                           ${isChecked ? 'checked' : ''}>
                    <label class="form-check-label" for="edit_specialty_${specialty.id}">
                        ${specialty.name}
                    </label>
                `;
                
                container.appendChild(div);
            });
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π:', error);
            container.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π</div>';
        }
    }
    
    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    function previewEditPhoto(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            const file = input.files[0];
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Ñ–∞–π–ª–∞
            if (!file.type.match('image/png')) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ PNG.');
                input.value = '';
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
            if (file.size > 5 * 1024 * 1024) {
                alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä - 5MB.');
                input.value = '';
                return;
            }
            
            reader.onload = function(e) {
                document.getElementById('edit_photo_preview').src = e.target.result;
                
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
                const lastName = document.getElementById('edit_last_name').value.trim().toLowerCase().replace(/\s+/g, '_');
                const firstName = document.getElementById('edit_first_name').value.trim().toLowerCase().replace(/\s+/g, '_');
                const timestamp = new Date().getTime();
                
                let fileName;
                if (lastName && firstName) {
                    fileName = `doctor_${lastName}_${firstName}_${timestamp}.png`;
                } else {
                    fileName = `doctor_${timestamp}.png`;
                }
                
                document.getElementById('edit_photo_path').value = `/images/doctors/${fileName}`;
            };
            
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    document.getElementById('save-changes-btn').addEventListener('click', async function() {
        const form = editDoctorForm;
        const doctorId = document.getElementById('edit_doctor_id').value;
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π
        const specialtyCheckboxes = document.querySelectorAll('#edit-specialties-container input[type="checkbox"]:checked');
        if (specialtyCheckboxes.length === 0) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –≤—Ä–∞—á–∞.');
            return;
        }
        
        try {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const btn = this;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
            const formData = new FormData(form);
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                // –£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
                editDoctorModal.hide();
                alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                refreshList();
            } else {
                throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        } finally {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            const btn = document.getElementById('save-changes-btn');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-save me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
        }
    });
    
    // –ü—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Ä–∞—á–∞
    document.addEventListener('DOMContentLoaded', function() {
        const deleteForms = document.querySelectorAll('form[action*="/delete"]');
        deleteForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –≤—Ä–∞—á–∞?')) {
                    e.preventDefault();
                }
            });
        });
        
        const doctorForm = document.getElementById('doctor-form');
        if (doctorForm) {
            doctorForm.addEventListener('submit', function(e) {
                const specialtyCheckboxes = document.querySelectorAll('input[name="doctor[specialty_ids][]"]:checked');
                if (specialtyCheckboxes.length === 0) {
                    e.preventDefault();
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –≤—Ä–∞—á–∞.');
                    return false;
                }
                
                const bio = document.getElementById('bio').value.trim();
                if (bio.length < 10) {
                    e.preventDefault();
                    alert('–ë–∏–æ–≥—Ä–∞—Ñ–∏—è –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 10 —Å–∏–º–≤–æ–ª–æ–≤.');
                    return false;
                }
                
                const photoInput = document.getElementById('photo');
                if (photoInput.files.length > 0) {
                    const file = photoInput.files[0];
                    if (!file.type.match('image/png')) {
                        e.preventDefault();
                        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ PNG.');
                        return false;
                    }
                    if (file.size > 5 * 1024 * 1024) {
                        e.preventDefault();
                        alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä - 5MB.');
                        return false;
                    }
                }
                
                const photoPathInput = document.getElementById('photo_path');
                if (photoInput.files.length > 0 && !photoPathInput.value) {
                    const lastName = document.getElementById('last_name').value.trim().toLowerCase().replace(/\s+/g, '_');
                    const firstName = document.getElementById('first_name').value.trim().toLowerCase().replace(/\s+/g, '_');
                    const timestamp = new Date().getTime();
                    
                    let fileName;
                    if (lastName && firstName) {
                        fileName = `doctor_${lastName}_${firstName}_${timestamp}.png`;
                    } else {
                        fileName = `doctor_${timestamp}.png`;
                    }
                    
                    photoPathInput.value = `/images/doctors/${fileName}`;
                }
            });
        }
        
        updatePreviewBackground();
    });
    
    function previewPhoto(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            const file = input.files[0];
            
            if (!file.type.match('image/png')) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ PNG. PNG –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω.');
                input.value = '';
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä - 5MB.');
                input.value = '';
                return;
            }
            
            reader.onload = function(e) {
                const preview = document.getElementById('photo-preview');
                preview.src = e.target.result;
                
                const lastName = document.getElementById('last_name').value.trim().toLowerCase().replace(/\s+/g, '_');
                const firstName = document.getElementById('first_name').value.trim().toLowerCase().replace(/\s+/g, '_');
                const timestamp = new Date().getTime();
                
                let fileName;
                if (lastName && firstName) {
                    fileName = `doctor_${lastName}_${firstName}_${timestamp}.png`;
                } else {
                    fileName = `doctor_${timestamp}.png`;
                }
                
                document.getElementById('photo_path').value = `/images/doctors/${fileName}`;
                updatePreviewBackground();
            };
            
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    function updatePreviewBackground() {
        const lastNameInput = document.getElementById('last_name');
        const previewBg = document.getElementById('preview-bg');
        
        if (previewBg && lastNameInput) {
            const lastName = lastNameInput.value.trim();
            let bgClass;
            
            if (lastName.length > 0) {
                const firstLetter = lastName.toLowerCase().charCodeAt(0);
                bgClass = (firstLetter % 2 === 0) ? 'bg-preview-0' : 'bg-preview-1';
            } else {
                bgClass = 'bg-preview-0';
            }
            
            previewBg.className = 'photo-background ' + bgClass;
        }
    }
    
    const lastNameInput = document.getElementById('last_name');
    if (lastNameInput) {
        lastNameInput.addEventListener('input', updatePreviewBackground);
    }
    
    const previewContainer = document.getElementById('preview-container');
    if (previewContainer) {
        previewContainer.addEventListener('click', function() {
            document.getElementById('photo').click();
        });
        
        previewContainer.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = '#e5a7ff';
            this.style.boxShadow = '0 0 0 3px rgba(229, 167, 255, 0.3)';
        });
        
        previewContainer.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = '';
            this.style.boxShadow = '';
        });
        
        previewContainer.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = '';
            this.style.boxShadow = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (!file.type.match('image/png')) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ PNG.');
                    return;
                }
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                document.getElementById('photo').files = dataTransfer.files;
                previewPhoto(document.getElementById('photo'));
            }
        });
    }
</script>
