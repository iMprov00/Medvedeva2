<!-- views/pages/doctors.erb или views/dynamic/doctors.erb -->
<!-- Заголовок страницы -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="display-4 fw-bold mb-3">Наши врачи</h1>
                <p class="lead text-muted mb-0">Профессиональная команда специалистов, которые помогут вашему ребенку сохранить здоровье</p>
            </div>
        </div>
    </div>
</section>

<!-- Поиск и фильтры -->
<section class="py-5">
    <div class="container">
        <div class="row g-3 mb-5">
            <div class="col-md-8">
                <div class="input-group input-group-lg">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="bi bi-search text-muted"></i>
                    </span>
                    <input type="text" 
                           id="doctor-search" 
                           class="form-control border-start-0" 
                           placeholder="Поиск врачей по ФИО...">
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-flex gap-2">
                    <select id="specialty-filter" class="form-select form-select-lg">
                        <option value="">Все специальности</option>
                        <% @specialties.each do |specialty| %>
                            <option value="<%= specialty %>"><%= specialty %></option>
                        <% end %>
                    </select>
                    <button id="reset-filters" class="btn btn-outline-secondary btn-lg">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Список врачей -->
        <div class="doctors-grid">
            <div class="row g-4" id="doctors-list">
                <% if @doctors.empty? %>
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="bi bi-people display-1 text-muted mb-3"></i>
                            <h4 class="mb-3">Врачи не найдены</h4>
                            <p class="text-muted">Попробуйте изменить условия поиска</p>
                        </div>
                    </div>
                <% else %>
                    <% @doctors.each_with_index do |doctor, index| %>
                        <div class="col-md-6 col-lg-4 fade-in-up">
                            <%= erb :'dynamic/_doctor_card', locals: { doctor: doctor, index: index } %>
                        </div>
                    <% end %>
                <% end %>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('doctor-search');
    const specialtyFilter = document.getElementById('specialty-filter');
    const resetBtn = document.getElementById('reset-filters');
    const doctorsList = document.getElementById('doctors-list');
    
    // Функция для применения цветов к фото врачей
    function applyDoctorColors() {
        const doctorCards = document.querySelectorAll('.doctor-card');
        doctorCards.forEach((card, index) => {
            const photoContainer = card.querySelector('.doctor-photo-container');
            if (photoContainer) {
                // Удаляем предыдущие классы
                photoContainer.classList.remove('bg-doctor-0', 'bg-doctor-1');
                // Добавляем класс на основе индекса (чередование)
                photoContainer.classList.add(`bg-doctor-${index % 2}`);
                
                // Альтернативно можно устанавливать цвет напрямую
                const wrapper = card.querySelector('.doctor-photo-wrapper');
                if (wrapper) {
                    const bgColor = index % 2 === 0 ? '#77e0b2' : '#e5a7ff';
                    wrapper.style.backgroundColor = bgColor;
                }
            }
        });
    }
    
    // Инициализация модального окна для записи
    const appointmentModal = new bootstrap.Modal(document.getElementById('appointmentModal'));
    const appointmentDoctorId = document.getElementById('appointmentDoctorId');
    const appointmentDoctorName = document.getElementById('doctorName');
    const specialtiesSelect = document.getElementById('specialtiesSelect');
    const submitAppointmentBtn = document.getElementById('submitAppointment');
    
    // Загружаем специальности при загрузке страницы
    loadSpecialties();
    
    // Обработчик клика на кнопку записи
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-appointment') || 
            e.target.closest('.btn-appointment')) {
            e.preventDefault();
            
            const button = e.target.classList.contains('btn-appointment') ? 
                          e.target : e.target.closest('.btn-appointment');
            
            const doctorId = button.getAttribute('data-doctor-id');
            const doctorName = button.getAttribute('data-doctor-name');
            
            // Устанавливаем данные в модальное окно
            appointmentDoctorId.value = doctorId;
            appointmentDoctorName.value = doctorName;
            
            // Загружаем специальности этого врача
            loadDoctorSpecialties(doctorId);
            
            // Показываем модальное окно
            appointmentModal.show();
        }
    });
    
    // Функция для загрузки всех специальностей
    function loadSpecialties() {
        fetch('/specialties')
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    specialtiesSelect.innerHTML = '<option value="">Выберите специальность</option>';
                    data.forEach(specialty => {
                        const option = document.createElement('option');
                        option.value = specialty.id;
                        option.textContent = specialty.name;
                        specialtiesSelect.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Ошибка загрузки специальностей:', error));
    }
    
    // Функция для загрузки специальностей конкретного врача
    function loadDoctorSpecialties(doctorId) {
        if (!doctorId) return;
        
        fetch(`/doctors/${doctorId}/specialties`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    specialtiesSelect.innerHTML = '<option value="">Выберите специальность</option>';
                    data.forEach(specialty => {
                        const option = document.createElement('option');
                        option.value = specialty.id;
                        option.textContent = specialty.name;
                        specialtiesSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Ошибка загрузки специальностей врача:', error);
                // В случае ошибки показываем все специальности
                loadSpecialties();
            });
    }
    
    // Обработчик отправки формы записи
    if (submitAppointmentBtn) {
        submitAppointmentBtn.addEventListener('click', function() {
            const form = document.getElementById('appointmentForm');
            const formData = new FormData(form);
            
            // Валидация
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            
            // Показываем индикатор загрузки
            const originalText = submitAppointmentBtn.innerHTML;
            submitAppointmentBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Отправка...';
            submitAppointmentBtn.disabled = true;
            
            // Отправляем запрос
            fetch('/appointments', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Показываем сообщение об успехе
                    alert(data.message);
                    // Закрываем модальное окно
                    appointmentModal.hide();
                    // Сбрасываем форму
                    form.reset();
                    form.classList.remove('was-validated');
                } else {
                    // Показываем ошибки
                    alert(data.errors ? data.errors.join('\n') : data.error || 'Произошла ошибка');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при отправке. Попробуйте еще раз.');
            })
            .finally(() => {
                // Восстанавливаем кнопку
                submitAppointmentBtn.innerHTML = originalText;
                submitAppointmentBtn.disabled = false;
            });
        });
    }
    
    // Функция для фильтрации врачей
    function filterDoctors() {
        const searchTerm = searchInput.value;
        const specialty = specialtyFilter.value;
        
        // Показываем индикатор загрузки
        doctorsList.innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="mt-3 text-muted">Поиск врачей...</p>
            </div>
        `;
        
        fetch('/doctors/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Accept': 'application/json'
            },
            body: new URLSearchParams({
                query: searchTerm,
                specialty: specialty
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.html) {
                let html = '';
                if (data.count === 0) {
                    html = `
                        <div class="col-12">
                            <div class="text-center py-5">
                                <i class="bi bi-people display-1 text-muted mb-3"></i>
                                <h4 class="mb-3">Врачи не найдены</h4>
                                <p class="text-muted">Попробуйте изменить условия поиска</p>
                            </div>
                        </div>`;
                } else {
                    // Разделяем HTML на отдельные карточки
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.html;
                    
                    const doctorCards = tempDiv.querySelectorAll('.doctor-card');
                    
                    if (doctorCards.length === 0) {
                        // Если карточки не найдены, возможно пришел HTML с обертками
                        doctorCards.forEach((card, index) => {
                            // Клонируем карточку
                            const cardClone = card.cloneNode(true);
                            
                            // Добавляем индекс как data-атрибут
                            cardClone.setAttribute('data-doctor-index', index);
                            
                            // Обертываем в колонку
                            html += `
                                <div class="col-md-6 col-lg-4 fade-in-up">
                                    ${cardClone.outerHTML}
                                </div>`;
                        });
                    } else {
                        // Иначе обертываем как есть
                        html = data.html;
                    }
                }
                doctorsList.innerHTML = html;
                
                // Применяем цвета после обновления DOM
                setTimeout(applyDoctorColors, 10);
                
                // Добавляем анимацию появления
                const fadeElements = doctorsList.querySelectorAll('.fade-in-up');
                fadeElements.forEach((el, idx) => {
                    setTimeout(() => {
                        el.style.opacity = '1';
                        el.style.transform = 'translateY(0)';
                    }, idx * 100);
                });
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            doctorsList.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Ошибка при загрузке данных. Пожалуйста, обновите страницу.
                    </div>
                </div>`;
        });
    }
    
    // Дебаунс для поиска
    let timeoutId;
    function debouncedSearch() {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(filterDoctors, 300);
    }
    
    // Обработчики событий
    if (searchInput) {
        searchInput.addEventListener('input', debouncedSearch);
    }
    
    if (specialtyFilter) {
        specialtyFilter.addEventListener('change', filterDoctors);
    }
    
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            if (searchInput) searchInput.value = '';
            if (specialtyFilter) specialtyFilter.value = '';
            filterDoctors();
        });
    }
    
    // Инициализация анимаций
    function initAnimations() {
        const fadeElements = doctorsList.querySelectorAll('.fade-in-up');
        fadeElements.forEach(el => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(20px)';
            el.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        });
        
        // Запускаем анимацию после небольшой задержки
        setTimeout(() => {
            fadeElements.forEach((el, idx) => {
                setTimeout(() => {
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                }, idx * 100);
            });
        }, 300);
    }
    
    // Применяем цвета и анимации при загрузке
    applyDoctorColors();
    initAnimations();
    
    // Обработчик изменения размера окна (на случай перестройки сетки)
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(applyDoctorColors, 100);
    });
});
</script>

<style>
/* CSS для чередования цветов и анимаций */
.fade-in-up {
    opacity: 0;
    transform: translateY(20px);
    animation: fadeInUp 0.5s ease forwards;
}

@keyframes fadeInUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Чередование цветов фона для контейнеров с фото */
.doctor-card:nth-child(odd) .doctor-photo-container {
    background-color: #77e0b2;
}

.doctor-card:nth-child(even) .doctor-photo-container {
    background-color: #e5a7ff;
}

/* Для поддержки динамического добавления через AJAX */
#doctors-list > .col-md-6:nth-child(odd) .doctor-card .doctor-photo-container {
    background-color: #77e0b2 !important;
}

#doctors-list > .col-md-6:nth-child(even) .doctor-card .doctor-photo-container {
    background-color: #e5a7ff !important;
}

/* Стили для фото врачей */
.doctor-photo-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 280px;
    overflow: hidden;
    position: relative;
}

.doctor-photo-wrapper img {
    max-height: 100%;
    max-width: 100%;
    object-fit: contain;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
    transition: transform 0.3s ease;
}

.doctor-photo-wrapper img:hover {
    transform: scale(1.05);
}

/* Стили для поиска */
#doctor-search:focus, #specialty-filter:focus {
    border-color: #e5a7ff;
    box-shadow: 0 0 0 0.25rem rgba(229, 167, 255, 0.25);
}

/* Адаптивность */
@media (max-width: 768px) {
    .doctor-photo-wrapper {
        height: 240px;
    }
}

@media (max-width: 576px) {
    .doctor-photo-wrapper {
        height: 200px;
    }
}
</style>